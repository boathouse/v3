<!DOCTYPE html>
<html lang="ru">
	<head>
		<title>three.js webgl - shaders - ocean</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>

			body {
				color: #000;
				font-family:Monospace;
				font-size:13px;
				margin: 0px;
				overflow: hidden;
			}

			#info {
				position: absolute;
				top: 0px; width: 100%;
				text-align:center;
				padding: 5px;
			}

			        #shot {
    position: absolute;
    top: 0px;
    right: 0px;
    margin: 5px;
     z-index: 101;
}

#fs {
    position: absolute;
    top: 30px;
    right: 0px;
    margin: 5px;
     z-index: 101;
}

		</style>
	</head>
	<body>

		<div id="container"></div>
		<button id="shot">Screenshot</button>
		<button id="fs">Fullscreen</button>
		
		<script src="assets/js/three.lib.js"></script>
        <script src="assets/js/Water.js"></script>
        
		<!-- <script src="build/three.js"></script>

		<script src="examples/js/controls/OrbitControls.js"></script>
		<script src="examples/js/objects/Water.js"></script>

		<script src="examples/js/Detector.js"></script>
		<script src="examples/js/libs/stats.min.js"></script>
		<script src="examples/js/libs/dat.gui.min.js"></script> -->

		<script>

			if ( ! Detector.webgl ) Detector.addGetWebGLMessage();

			var container, stats;
			var camera, scene, renderer, light;
			var controls, water, sphere, cubeMap, skyBox;

			var loader;

			var parameters = {
				oceanSide: 1000,
				size: 1.0,
				distortionScale: 1.0,
				alpha: 0.6
			};

			_real = false;

			init();
			

			function init() {

				container = document.getElementById( 'container' );

				//

				renderer = new THREE.WebGLRenderer({antialias: true, alpha: true});
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );
				//renderer.shadowMap.enabled = true;
				container.appendChild( renderer.domElement );

				//

				scene = new THREE.Scene();
				scene.fog = new THREE.FogExp2( 0x3f4d5a, 0.001 );

				//

				camera = new THREE.PerspectiveCamera( 55, window.innerWidth / window.innerHeight, 1, 20000 );
				camera.position.set( 10, 10, 50 );

				//

				light = new THREE.DirectionalLight( 0xffffff, 1 );
				light.position.set( - 30, 30, 30 );
				//light.castShadow = true;
				// light.shadow.camera.top = 45;
				// light.shadow.camera.right = 40;
				// light.shadow.camera.left = light.shadow.camera.bottom = -40;
				// light.shadow.camera.near = 1;
				// light.shadow.camera.far = 200;
				scene.add( light );

				var _light = new THREE.DirectionalLight( 0xcccccc, 0.3 );
				_light.position.set( 30, -30, 30 );
				//light.castShadow = true;
				// light.shadow.camera.top = 45;
				// light.shadow.camera.right = 40;
				// light.shadow.camera.left = light.shadow.camera.bottom = -40;
				// light.shadow.camera.near = 1;
				// light.shadow.camera.far = 200;
				scene.add( _light );

				var ambientLight = new THREE.AmbientLight( 0xdddddd, 0.8 );
				scene.add( ambientLight );

				//

				setWater();

				//

				setSkybox();

				loader = new THREE.SEA3D( {
         
		             container : scene 
		         
		         } );

				//loader.load( 'assets/models/scene2.sea' );

				loader.load( 'assets/models/fisher.sea' );

				//

				// var geometry = new THREE.IcosahedronGeometry( 20, 2 );

				// for ( var i = 0, j = geometry.faces.length; i < j; i ++ ) {

				// 	geometry.faces[ i ].color.setHex( Math.random() * 0xffffff );

				// }

				// var material = new THREE.MeshPhongMaterial( {
				// 	vertexColors: THREE.FaceColors,
				// 	shininess: 10,
				// 	envMap: cubeMap,
				// 	side: THREE.DoubleSide
				// } );

				// sphere = new THREE.Mesh( geometry, material );
				// sphere.castShadow = true;
				// scene.add( sphere );

				//

				controls = new THREE.OrbitControls( camera, renderer.domElement );
				//controls.maxPolarAngle = Math.PI * 0.495;
				controls.target.set( 0, 0, 0 );
				//controls.enablePan = false;
				//controls.minDistance = 40.0;
				controls.maxDistance = 200.0;
				

				 controls.enableDamping = true;
             controls.dampingFactor = 0.2;
             controls.zoomSpeed = 0.4;
             controls.rotateSpeed = 0.3;
             controls.autoRotate = true;
             controls.autoRotateSpeed = 0.2;

             camera.lookAt( controls.target );

				//

				stats = new Stats();
				container.appendChild( stats.dom );

				//

				// gui = new dat.GUI();

				// gui.add( parameters, 'distortionScale', 0, 8, 0.1 );
				// gui.add( parameters, 'size', 0.1, 10, 0.1 );
				// gui.add( parameters, 'alpha', 0.9, 1, .001 );

				//

				window.addEventListener( 'resize', onWindowResize, false );

				//document.getElementById("shot").addEventListener('click', takeScreenshot);
				//document.getElementById("fs").addEventListener('click', toggleFullScreen);


				document.getElementById("shot").addEventListener('click', function(){_real == false ? _real = true : _real = false;});

				document.getElementById("fs").addEventListener('click', function(){controls.autoRotate == false ? controls.autoRotate = true : controls.autoRotate = false;});

				//Events



				var initSound = function initSound( url,loop ) {
				
					if ( window.HTMLAudioElement ) {
					
						var sound = new Audio('');

						if ( sound.canPlayType( 'audio/mp3' ) ) {
						
							var sound = new Audio( url );
							var dur = 63;

							//console.log(sound.duration);
							
							
							if(loop) {
								// var _sound = new Audio( 'assets/sound/splash.mp3' );
								// setTimeout(function(){ _sound.play()}, dur * 1000);
								// _sound.addEventListener( 'play', function() {
								// 	this.currentTime = 0;
								// 	setTimeout(function(){ _sound.play()}, dur * 1000);
								// }, false );

								sound.play();
								//sound.addEventListener("play", function(){
									//var _sound = new Audio( 'assets/sound/splash.mp3' );
									//console.log(sound.duration);
									//var _duration = this.duration - 1;
									//setTimeout(function(){console.log('-----------------------------------------------'); _sound.play()}, 63 * 1000);

								//}, false);

							sound.addEventListener( 'ended', function() {
								this.currentTime = 0;
								this.play();
							}, false );
						} else {
							sound.addEventListener( 'ended', function() {
								this.currentTime = 0;
								var min = 30, max = 80;
  								var rand = Math.floor(Math.random() * (max - min + 1) + min);
  								console.log(rand);
  								setTimeout(function(){sound.play()}, rand * 1000);
								
							}, false );

							setTimeout(function(){sound.play()},  50000);
						}
							
							return sound;
							
						}
						
					}
					
				};
				
				var ms_soundWaves = initSound( 'assets/sound/lake2.mp3', true); 
				var ms_soundFrog = initSound( 'assets/sound/amb.mp3', false);
				//var ms_sound = initSound( 'assets/sound/splash.mp3' ,false);

				// ms_sound.addEventListener( 'ended', function() {

								

				// 				//console.log(this.duration);
				// 				this.currentTime = 0;
				// 				this.play();
				// 			}, false );
				
				
				//ms_soundWaves.play();
				//console.log(ms_soundWaves);

				animate();

			}




			function takeScreenshot() {
				skyBox.visible = false;
				water.visible = false;
	            // open in new window like this
	            //var w = window.open('', '');
	            //w.document.title = "Screenshot";
	            //w.document.body.style.backgroundColor = "red";
	            //var img = new Image();
	            // Without 'preserveDrawingBuffer' set to true, we must render now
	            //renderer.render(scene, camera);
	            //img.src = renderer.domElement.toDataURL();
	            //w.document.body.appendChild(img);
	            
	            
	            
	            var a = document.createElement('a');
	            //Without 'preserveDrawingBuffer' set to true, we must render now
	            renderer.render(scene, camera);
	            a.href = renderer.domElement.toDataURL().replace("image/png", "image/octet-stream");
	            a.download = 'canvas.png';

        //link.setAttribute("download", fileName);
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
	            //a.click();

	            skyBox.visible = true;
				water.visible = true;
	        }





function toggleFullScreen() {
  if (!document.fullscreenElement &&    // alternative standard method
      !document.mozFullScreenElement && !document.webkitFullscreenElement && !document.msFullscreenElement ) {  // current working methods
    if (document.documentElement.requestFullscreen) {
      document.documentElement.requestFullscreen();
    } else if (document.documentElement.msRequestFullscreen) {
      document.documentElement.msRequestFullscreen();
    } else if (document.documentElement.mozRequestFullScreen) {
      document.documentElement.mozRequestFullScreen();
    } else if (document.documentElement.webkitRequestFullscreen) {
      document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
    }
  } else {
    if (document.exitFullscreen) {
      document.exitFullscreen();
    } else if (document.msExitFullscreen) {
      document.msExitFullscreen();
    } else if (document.mozCancelFullScreen) {
      document.mozCancelFullScreen();
    } else if (document.webkitExitFullscreen) {
      document.webkitExitFullscreen();
    }
  }
}


















			function setWater() {

				var waterGeometry = new THREE.PlaneBufferGeometry( parameters.oceanSide * 5, parameters.oceanSide * 5 );

				water = new THREE.Water(
					waterGeometry,
					{
						textureWidth: 512,
						textureHeight: 512,
						waterNormals: new THREE.TextureLoader().load( 'assets/textures/waternormals.jpg', function ( texture ) {
							texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
						}),
						//side: THREE.DoubleSide,
						alpha: parameters.alpha,
						sunDirection: light.position.clone().normalize(),
						sunColor: 0xffffff,
						waterColor: 0x001e0f,
						distortionScale: parameters.distortionScale,
						fog: scene.fog !== undefined
					}
				);

				water.position.y = -1.5;

				water.rotation.x = - Math.PI / 2;
				water.receiveShadow = true;

				scene.add( water );

			}

			function setSkybox() {

				var cubeTextureLoader = new THREE.CubeTextureLoader();
				cubeTextureLoader.setPath( 'assets/textures/skybox4/' );

				cubeMap = cubeTextureLoader.load( [
					'px.jpg', 'nx.jpg',
					'py.jpg', 'ny.jpg',
					'pz.jpg', 'nz.jpg',
				] );

				var cubeShader = THREE.ShaderLib[ 'cube' ];
				cubeShader.uniforms[ 'tCube' ].value = cubeMap;

				var skyBoxMaterial = new THREE.ShaderMaterial( {
					fragmentShader: cubeShader.fragmentShader,
					vertexShader: cubeShader.vertexShader,
					uniforms: cubeShader.uniforms,
					side: THREE.BackSide
				} );

				var skyBoxGeometry = new THREE.BoxBufferGeometry(
					parameters.oceanSide * 5 + 100,
					parameters.oceanSide * 5 + 100,
					parameters.oceanSide * 5 + 100 );

				skyBox = new THREE.Mesh( skyBoxGeometry, skyBoxMaterial );

				scene.add( skyBox );

			}

			function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );

			}

			function animate() {

				requestAnimationFrame( animate );
				render();
				stats.update();
				controls.update();

			}

			function render() {

				

				// sphere.position.y = Math.sin( time ) * 20 + 5;
				// sphere.rotation.x = time * 0.5;
				// sphere.rotation.z = time * 0.51;

				if(_real){

				var time = performance.now() * 0.001;

				water.material.uniforms.time.value += 1.0 / 60.0;
				//water.material.uniforms.size.value = parameters.size;
				//water.material.uniforms.distortionScale.value = parameters.distortionScale;
				//water.material.uniforms.alpha.value = parameters.alpha;
				}

				renderer.render( scene, camera );

			}

		</script>
	</body>
</html>
